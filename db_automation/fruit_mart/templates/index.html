<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mart Management</title>
    <link rel="stylesheet" href="{% static 'fruit_mart/styles.css' %}">
    <script>
        //현재 재고 출력
        async function fetchInventory(){
            const response = await fetch('fruit_mart/inventory');
            const data = await response.json();
            document.getElementById("inventory").innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }
        // 소비자 생성
        async function createCustomer() {
            const name = document.getElementById("customer-name").value;

            if (!name || !email) {
                alert("모든 필드를 입력해주세요.");
                return;
            }

            const response = await fetch('/customer/create/', {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ name, email })
            });

            const data = await response.json();
            document.getElementById("customer-result").textContent = data.message || data.error;
        }

        // 과일 입고
        async function addFruitStock() {
            const item = document.getElementById("fruit-item").value;
            const quantity = document.getElementById("fruit-quantity").value;

            if (!item || !quantity) {
                alert("모든 필드를 입력해주세요.");
                return;
            }

            const response = await fetch('/fruit_mart/add-stock/', {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ item, quantity })
            });

            const data = await response.json();
            document.getElementById("fruit-result").textContent = data.message || data.error;
        }

        //과일 조회
        async function fetchFruitDetails() {
            const item = document.getElementById("fruit-name").value;

            if (!item) {
                alert("과일 이름을 입력해주세요.");
                return;
            }

            const response = await fetch(`/fruit_mart/fruit-details/?item=${item}`);
            const data = await response.json();
            document.getElementById("fruit-details").innerHTML = `<pre>${JSON.stringify(data.details, null, 2)}</pre>`;
        }

        // 주문 처리
        async function placeOrder() {
            const customerId = document.getElementById("order-customer-id").value;
            const item = document.getElementById("order-item").value;
            const quantity = document.getElementById("order-quantity").value;

            if (!customerId || !item || !quantity) {
                alert("모든 필드를 입력해주세요.");
                return;
            }

            const response = await fetch('/order/place/', {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ customer_id: customerId, item, quantity })
            });

            const data = await response.json();
            document.getElementById("order-result").textContent = data.message || data.error;
        }
        
        //주문 조회
        async function fetchOrders() {
            const customerName = document.getElementById("order-customer-name").value;

            if (!customerName) {
                alert("소비자 이름을 입력해주세요.");
                return;
            }

            const response = await fetch(`/order/customer-orders/?customer_name=${customerName}`);
            const data = await response.json();
            document.getElementById("order-results").innerHTML = `<pre>${JSON.stringify(data.orders, null, 2)}</pre>`;
        }

        // 환불 처리
        async function processRefund() {
            const customerName = document.getElementById("refund-customer-name").value;
            const orderId = document.getElementById("refund-order-id").value;
            const item = document.getElementById("refund-item").value;
            const refundQuantity = document.getElementById("refund-quantity").value;

            if (!customerName || !orderId || !item || !refundQuantity) {
                alert("모든 필드를 입력해주세요.");
                return;
            }

            const response = await fetch('/order/refund/', {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    customer_name: customerName,
                    order_id: orderId,
                    item,
                    refund_quantity: refundQuantity
                })
            });

            const data = await response.json();
            document.getElementById("refund-result").textContent = data.message || data.error;
        }
    </script>
</head>
<body>
    <div class="container">
        <h1>Mart Management</h1>

        <!-- 현재 재고 조회 -->
        <h2>현재 재고 조회</h2>
        <button onclick="fetchInventory()">현재 재고 확인</button>
        <div id="inventory" class="result"></div>
        <!-- 소비자 생성 -->
        <h2>소비자 생성</h2>
        <form onsubmit="createCustomer(); return false;">
            {% csrf_token %}
            <div>
                <label for="customer-name">이름:</label>
                <input id="customer-name" type="text" placeholder="소비자 이름">
            </div>
            <button type="submit">소비자 생성</button>
        </form>
        <div id="customer-result" class="result"></div>

        <!-- 과일 입고 -->
        <h2>과일 입고</h2>
        <form onsubmit="addFruitStock(); return false;">
            {% csrf_token %}
            <div>
                <label for="fruit-item">물품:</label>
                <input id="fruit-item" type="text" placeholder="예: 사과">
            </div>
            <div>
                <label for="fruit-quantity">수량:</label>
                <input id="fruit-quantity" type="number" placeholder="예: 10">
            </div>
            <button type="submit">입고</button>
        </form>
        <div id="fruit-result" class="result"></div>

        <!-- 과일 조회 -->
        <h2>과일 조회</h2>
        <form onsubmit="fetchFruitDetails(); return false;">
            <div>
                <label for="fruit-name">과일 이름:</label>
                <input id="fruit-name" type="text" placeholder="과일 이름 입력">
            </div>
            <button type="submit">조회</button>
        </form>
        <div id="fruit-details" class="result"></div>        

        <!-- 주문 -->
        <h2>주문</h2>
        <form onsubmit="placeOrder(); return false;">
            {% csrf_token %}
            <div>
                <label for="order-customer-id">소비자 ID:</label>
                <input id="order-customer-id" type="text" placeholder="소비자 이름 입력">
            </div>
            <div>
                <label for="order-item">물품:</label>
                <input id="order-item" type="text" placeholder="예: 사과">
            </div>
            <div>
                <label for="order-quantity">수량:</label>
                <input id="order-quantity" type="number" placeholder="예: 5">
            </div>
            <button type="submit">주문</button>
        </form>
        <div id="order-result" class="result"></div>

        <!-- 주문 조회 -->
        <h2>주문 조회</h2>
        <form onsubmit="fetchOrders(); return false;">
            <div>
                <label for="order-customer-name">소비자 이름:</label>
                <input id="order-customer-name" type="text" placeholder="소비자 이름 입력">
            </div>
            <button type="submit">조회</button>
        </form>
        <div id="order-results" class="result"></div>        

        <!-- 환불 -->
        <h2>환불 요청</h2>
        <form onsubmit="processRefund(); return false;">
            {% csrf_token %}
            <div>
                <label for="refund-customer-name">소비자 이름:</label>
                <input id="refund-customer-name" type="text" placeholder="소비자 이름 입력">
            </div>
            <div>
                <label for="refund-order-id">주문 ID:</label>
                <input id="refund-order-id" type="text" placeholder="주문 ID 입력">
            </div>
            <div>
                <label for="refund-item">과일 이름:</label>
                <input id="refund-item" type="text" placeholder="과일 이름 입력">
            </div>
            <div>
                <label for="refund-quantity">환불 수량:</label>
                <input id="refund-quantity" type="number" placeholder="환불할 수량 입력">
            </div>
            <button type="submit">환불 요청</button>
        </form>
        <div id="refund-result" class="result"></div>
    </div>
</body>
</html>
